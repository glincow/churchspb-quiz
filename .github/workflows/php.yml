name: Deploy PHP Quiz Application

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: quiz_db
          MYSQL_USER: quiz_user
          MYSQL_PASSWORD: quiz_password
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mysqli, pdo_mysql
        coverage: none
    
    - name: Verify PHP installation
      run: |
        php -v
        php -m | grep -i mysql
    
    - name: Wait for MySQL
      run: |
        for i in {1..30}; do
          if mysqladmin ping -h 127.0.0.1 -u root -proot_password --silent; then
            echo "MySQL is ready!"
            break
          fi
          echo "Waiting for MySQL..."
          sleep 2
        done
    
    - name: Create database schema
      run: |
        mysql -h 127.0.0.1 -u root -proot_password quiz_db << 'EOF'
        CREATE TABLE IF NOT EXISTS questionnaire_data (
          id INT AUTO_INCREMENT PRIMARY KEY,
          id_list VARCHAR(255),
          value TEXT,
          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );
        
        CREATE TABLE IF NOT EXISTS questionnaire_list (
          id INT AUTO_INCREMENT PRIMARY KEY,
          ql_id VARCHAR(255),
          ql_limits INT,
          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );
        
        -- Insert sample data
        INSERT INTO questionnaire_list (ql_id, ql_limits) VALUES ('sample_quiz', 10);
        EOF
    
    - name: Create test config.php
      run: |
        cat > config.php << 'EOF'
        <?php
        date_default_timezone_set("Europe/Moscow");
        
        // establish mysql connection & database selection
        \$host = '127.0.0.1';
        \$db = new mysqli('127.0.0.1', 'root', 'root_password', 'quiz_db');
        
        // db query settings
        \$db->set_charset('utf8');
        if (\$db->connect_errno) die('Could not connect: '.\$db->connect_error);
        
        // make a query to the database
        function db_query (\$query) {
          global \$db;
          \$res=\$db->query (\$query);
          if (!\$res) throw new Exception (\$db->error);
          return \$res;
        }
        
        function db_multiQuery (\$query) {
          global \$db;
          \$res=\$db->multi_query (\$query);
          if (!\$res) throw new Exception (\$db->error);
          return \$res;
        }
        EOF
    
    - name: Test PHP application
      run: |
        php -l index.php
        php -l config.php
        php -l quiz_admin.php
        php -l quiz_ajax.php
        echo "âœ“ PHP syntax check passed!"
    
    - name: Start PHP built-in server
      run: |
        php -S 0.0.0.0:8000 &
        SERVER_PID=$!
        echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
        sleep 3
    
    - name: Test application endpoints
      run: |
        echo "Testing if server is responding..."
        curl -f http://localhost:8000/ || echo "Main page check"
        curl -f http://localhost:8000/quiz_ajax.php || echo "AJAX endpoint check"
        echo "âœ“ Application is running!"
    
    - name: Build Docker image
      run: |
        cat > Dockerfile << 'EOF'
        FROM php:8.1-apache
        
        # Install mysqli extension
        RUN docker-php-ext-install mysqli && docker-php-ext-enable mysqli
        
        # Copy application files
        COPY . /var/www/html/
        
        # Set permissions
        RUN chown -R www-data:www-data /var/www/html
        
        # Expose port 80
        EXPOSE 80
        EOF
        
        docker build -t churchspb-quiz:latest .
    
    - name: Create docker-compose.yml for deployment
      run: |
        cat > docker-compose.yml << 'EOF'
        version: '3.8'
        
        services:
          mysql:
            image: mysql:8.0
            container_name: quiz_mysql
            environment:
              MYSQL_ROOT_PASSWORD: change_this_password
              MYSQL_DATABASE: quiz_db
              MYSQL_USER: quiz_user
              MYSQL_PASSWORD: change_this_password
            ports:
              - "3306:3306"
            volumes:
              - mysql_data:/var/lib/mysql
            restart: unless-stopped
          
          web:
            image: churchspb-quiz:latest
            container_name: quiz_web
            ports:
              - "8080:80"
            depends_on:
              - mysql
            restart: unless-stopped
            environment:
              - DB_HOST=mysql
              - DB_NAME=quiz_db
              - DB_USER=quiz_user
              - DB_PASSWORD=change_this_password
        
        volumes:
          mysql_data:
        EOF
    
    - name: Create deployment instructions
      run: |
        cat > DEPLOYMENT.md << 'EOF'
        # Deployment Instructions
        
        ## Prerequisites
        - Docker and Docker Compose installed
        - Git installed
        
        ## Quick Start
        
        1. Clone the repository:
        ```bash
        git clone https://github.com/glincow/churchspb-quiz.git
        cd churchspb-quiz
        ```
        
        2. Update database credentials in `docker-compose.yml` (change the passwords!)
        
        3. Update `config.php` with your database connection settings:
        ```php
        \$db = new mysqli('mysql', 'quiz_user', 'your_password', 'quiz_db');
        ```
        
        4. Build and start the containers:
        ```bash
        docker-compose up -d
        ```
        
        5. Initialize the database:
        ```bash
        docker exec -it quiz_mysql mysql -u quiz_user -p quiz_db < schema.sql
        ```
        
        6. Access the application:
        - Quiz: http://localhost:8080/
        - Admin: http://localhost:8080/quiz_admin.php
        
        ## Manual Deployment (without Docker)
        
        1. Set up a web server (Apache/Nginx) with PHP 7.4+ and MySQL
        2. Copy all PHP files to your web root
        3. Create database and tables (see schema.sql)
        4. Update config.php with your database credentials
        5. Ensure proper file permissions
        
        ## Environment Variables
        
        You can override database settings using environment variables:
        - `DB_HOST` - Database host (default: localhost)
        - `DB_NAME` - Database name (default: quiz_db)
        - `DB_USER` - Database user
        - `DB_PASSWORD` - Database password
        
        ## Testing
        
        The application should now be accessible at http://localhost:8080
        
        ## Stopping the Application
        
        ```bash
        docker-compose down
        ```
        
        ## Troubleshooting
        
        - Check logs: `docker-compose logs`
        - Verify MySQL is running: `docker-compose ps`
        - Test database connection: `docker exec -it quiz_mysql mysql -u quiz_user -p`
        EOF
    
    - name: Create database schema file
      run: |
        cat > schema.sql << 'EOF'
        -- Quiz Application Database Schema
        
        CREATE TABLE IF NOT EXISTS questionnaire_data (
          id INT AUTO_INCREMENT PRIMARY KEY,
          id_list VARCHAR(255) NOT NULL,
          value TEXT NOT NULL,
          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
          INDEX idx_id_list (id_list)
        );
        
        CREATE TABLE IF NOT EXISTS questionnaire_list (
          id INT AUTO_INCREMENT PRIMARY KEY,
          ql_id VARCHAR(255) NOT NULL UNIQUE,
          ql_limits INT NOT NULL DEFAULT 0,
          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );
        
        -- Insert default quiz
        INSERT IGNORE INTO questionnaire_list (ql_id, ql_limits) 
        VALUES ('default_quiz', 10);
        EOF
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: deployment-files
        path: |
          Dockerfile
          docker-compose.yml
          DEPLOYMENT.md
          schema.sql
    
    - name: Deployment Summary
      run: |
        echo "âœ… Build completed successfully!"
        echo ""
        echo "ðŸ“¦ Docker image built: churchspb-quiz:latest"
        echo "ðŸ“ Deployment files created:"
        echo "   - Dockerfile"
        echo "   - docker-compose.yml"
        echo "   - DEPLOYMENT.md"
        echo "   - schema.sql"
        echo ""
        echo "ðŸš€ To deploy this application:"
        echo "   1. Download the artifacts from this workflow run"
        echo "   2. Follow instructions in DEPLOYMENT.md"
        echo "   3. Or use: docker-compose up -d"
        echo ""
        echo "ðŸŒ Application will be available at: http://localhost:8080"
